
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check for Admin role
    function isAdmin() {
      // Check if the user document exists and has the 'Admin' role.
      // Use exists() for safety.
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'Admin';
    }

    // Users Collection
    match /users/{userId} {
      // Allow any authenticated user to read/list user profiles.
      // This is needed for UI elements like dropdowns and is considered safe
      // as profile data is not sensitive in this app's context.
      allow read: if request.auth != null;
      
      // Allow users to update their own profile, and admins to update any.
      allow update: if request.auth != null && (request.auth.uid == userId || isAdmin());
      
      // Only admins can delete user documents.
      allow delete: if request.auth != null && isAdmin();

      // Any authenticated user can create their own user document upon signup.
      // The UID in the document must match the authenticated user's UID.
      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;
    }

    // Overtime Records Collection
    match /overtimeRecords/{recordId} {
      // Any authenticated user can list records. 
      // Security is enforced by the application's queries, which are now robust.
      // An admin will query all, a user will query only their own.
      allow list: if request.auth != null;

      // An admin can get any record. A user can get their own.
      allow get: if request.auth != null && (isAdmin() || resource.data.employeeId == request.auth.uid);
      
      // A user can create their own record, ensuring the employeeId matches their auth UID.
      allow create: if request.auth != null && request.resource.data.employeeId == request.auth.uid;
      
      // An admin can update any record. A user can only update their own.
      allow update: if request.auth != null && (isAdmin() || resource.data.employeeId == request.auth.uid);

      // Only admins can delete records.
      allow delete: if request.auth != null && isAdmin();
    }
  }
}

    